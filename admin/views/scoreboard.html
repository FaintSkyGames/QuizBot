<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scoreboard</title>
    <link rel="stylesheet" href="{{STYLE}}" />
  </head>
  <body>
    <main class="board">
      <section class="board-panel">
        <header class="board-header">
          <h1 class="board-title">Scoreboard</h1>
          <p class="board-subtitle">Current Scores</p>
        </header>

        <div class="board-list" id="leaderboard-container">
          <!-- Player cards will be dynamically injected here -->
        </div>
      </section>
    </main>

    <script>
      async function fetchLeaderboard() {
        try {
          const res = await fetch("/scoreboard/json");
          if (!res.ok) throw new Error("Failed to fetch");
          return await res.json();
        } catch (err) {
          console.error(err);
          return [];
        }
      }

      function createPlayerCard(player, rank) {
        const avatarUrl = player.avatar
          ? `https://cdn.discordapp.com/avatars/${player.userId}/${player.avatar}.png`
          : `https://cdn.discordapp.com/embed/avatars/${
              parseInt(player.userId) % 5
            }.png`;

        const card = document.createElement("div");
        card.className = "row-card";
        card.dataset.userid = player.userId;
        card.innerHTML = `
          <div class="rank">${rank}</div>
          <div class="player">
            <img class="avatar" src="${avatarUrl}" alt="${player.name}">
            <div>
              <div class="name">${player.name}</div>
            </div>
          </div>
          <div class="score">${player.points}</div>
        `;
        return card;
      }

      //   function createPlayerCard(player, rank) {
      //     const avatarUrl = player.avatar
      //       ? `https://cdn.discordapp.com/avatars/${player.userId}/${player.avatar}.png`
      //       : `https://cdn.discordapp.com/embed/avatars/${
      //           parseInt(player.userId) % 5
      //         }.png`;

      //     // data-userid="${player.userId}"
      //     return `
      //     <div class="row-card new" data-userid="${player.userId}">
      //       <div class="rank">${rank}</div>
      //       <div class="player">
      //         <img class="avatar" src="${avatarUrl}" alt="${player.name}">
      //         <div>
      //           <div class="name">${player.name}</div>

      //       </div>
      //       <div class="score">${player.points}</div>
      //     </div>
      //   `;
      //   }

      async function updateLeaderboard() {
        const container = document.getElementById("leaderboard-container");
        const newData = await fetchLeaderboard();

        if (newData.length === 0) {
          container.innerHTML = '<div class="empty">No players found</div>';
          return;
        }

        const oldCards = new Map(
          Array.from(container.children).map((el) => [el.dataset.userid, el])
        );

        newData.forEach((player, i) => {
          const existing = oldCards.get(player.userId);

          if (existing) {
            // Update rank
            existing.querySelector(".rank").textContent = i + 1;

            // Update name if changed
            const nameEl = existing.querySelector(".name");
            if (nameEl.textContent !== player.name) {
              nameEl.textContent = player.name;
            }

            // Update score if changed
            const scoreEl = existing.querySelector(".score");
            if (scoreEl.textContent !== String(player.points)) {
              scoreEl.textContent = player.points;
            }

            // Update avatar if changed
            const avatarEl = existing.querySelector(".avatar");
            const newAvatarUrl = player.avatar
              ? `https://cdn.discordapp.com/avatars/${player.userId}/${player.avatar}.png`
              : `https://cdn.discordapp.com/embed/avatars/${
                  parseInt(player.userId) % 5
                }.png`;
            if (avatarEl.src !== newAvatarUrl) {
              avatarEl.src = newAvatarUrl;
            }

            container.appendChild(existing); // move to new order
          } else {
            // New player
            const newCard = createPlayerCard(player, i + 1);
            newCard.style.opacity = 0;
            container.appendChild(newCard);
            requestAnimationFrame(() => {
              newCard.style.transition = "opacity 0.5s";
              newCard.style.opacity = 1;
            });
          }
        });

        // Remove players not in newData
        oldCards.forEach((card, id) => {
          if (!newData.find((p) => p.userId === id)) {
            card.style.transition = "opacity 0.5s";
            card.style.opacity = 0;
            setTimeout(() => card.remove(), 500);
          }
        });
      }

      //   async function updateLeaderboard() {
      //     const container = document.getElementById("leaderboard-container");
      //     const newData = await fetchLeaderboard();

      //     if (newData.length === 0) {
      //       container.innerHTML = '<div class="empty">No players found</div>';
      //       return;
      //     }

      //     const oldCards = Array.from(container.children);
      //     const oldPositions = {};
      //     oldCards.forEach((card) => {
      //       const id = card.dataset.userid;
      //       oldPositions[id] = card.getBoundingClientRect().top;
      //     });

      //     // Generate new HTML
      //     container.innerHTML = newData
      //       .map((p, i) => createPlayerCard(p, i + 1))
      //       .join("");

      //     const newCards = Array.from(container.children);

      //     // Animate FLIP for position changes
      //     newCards.forEach((card) => {
      //       const id = card.dataset.userid;
      //       const oldTop = oldPositions[id] || card.getBoundingClientRect().top;
      //       const newTop = card.getBoundingClientRect().top;
      //       const delta = oldTop - newTop;

      //       if (delta) {
      //         card.style.transform = `translateY(${delta}px)`;
      //         card.style.transition = "transform 0s";
      //         requestAnimationFrame(() => {
      //           card.style.transition = "transform 0.5s ease, opacity 0.5s ease";
      //           card.style.transform = "translateY(0)";
      //           card.classList.remove("new", "removed");
      //         });
      //       } else {
      //         card.style.opacity = 1; // new players fade in
      //       }
      //     });
      //   }

      window.onload = () => {
        updateLeaderboard();
        setInterval(updateLeaderboard, 20000); // refresh every 35s
      };
    </script>
  </body>
</html>
